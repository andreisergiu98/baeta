"use strict";(self.webpackChunk_baeta_website=self.webpackChunk_baeta_website||[]).push([["9651"],{5253:function(e,n,a){a.r(n),a.d(n,{frontMatter:()=>l,default:()=>h,toc:()=>d,metadata:()=>r,assets:()=>o,contentTitle:()=>c});var r=JSON.parse('{"id":"extensions/caching","title":"Caching","description":"Baeta provides a powerful and flexible caching system with support for multiple storage adapters. The caching system offers automatic cache invalidation, parent-based invalidation, and type-safe cache operations.","source":"@site/docs/extensions/caching.mdx","sourceDirName":"extensions","slug":"/extensions/caching","permalink":"/docs/extensions/caching","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":30,"frontMatter":{"sidebar_position":30},"sidebar":"defaultSidebar","previous":{"title":"Complexity","permalink":"/docs/extensions/complexity"},"next":{"title":"Plugins","permalink":"/docs/category/plugins"}}'),s=a(92669),t=a(51846),i=a(31867);let l={sidebar_position:30},c="Caching",o={},d=[{value:"Key Features",id:"key-features",level:2},{value:"Installation",id:"installation",level:2},{value:"Storage Adapters",id:"storage-adapters",level:2},{value:"Redis (Recommended)",id:"redis-recommended",level:3},{value:"Upstash (Recommended for Serverless)",id:"upstash-recommended-for-serverless",level:3},{value:"Cloudflare Durable Objects",id:"cloudflare-durable-objects",level:3},{value:"Keyv (Limited)",id:"keyv-limited",level:3},{value:"Basic Setup",id:"basic-setup",level:2},{value:"Caching Examples",id:"caching-examples",level:2},{value:"Basic Query Caching",id:"basic-query-caching",level:3},{value:"Mutation Handling",id:"mutation-handling",level:3},{value:"Cache Clearing",id:"cache-clearing",level:3},{value:"Parent-Based Cache Clearing",id:"parent-based-cache-clearing",level:3},{value:"Best Practices",id:"best-practices",level:2}];function u(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"caching",children:"Caching"})}),"\n",(0,s.jsx)(n.p,{children:"Baeta provides a powerful and flexible caching system with support for multiple storage adapters. The caching system offers automatic cache invalidation, parent-based invalidation, and type-safe cache operations."}),"\n",(0,s.jsx)(n.h2,{id:"key-features",children:"Key Features"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Type-safe cache operations"}),"\n",(0,s.jsx)(n.li,{children:"Easy updates for stale cache"}),"\n",(0,s.jsx)(n.li,{children:"Automatic schema based invalidation"}),"\n",(0,s.jsx)(n.li,{children:"Multiple storage adapters"}),"\n",(0,s.jsx)(n.li,{children:"TTL support"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n","\n",(0,s.jsx)(i.p,{package:"@baeta/extension-cache"}),"\n",(0,s.jsx)(n.h2,{id:"storage-adapters",children:"Storage Adapters"}),"\n",(0,s.jsx)(n.p,{children:"Baeta supports several storage adapters for different use cases:"}),"\n",(0,s.jsx)(n.h3,{id:"redis-recommended",children:"Redis (Recommended)"}),"\n",(0,s.jsx)(n.p,{children:"Best for production environments with high query volumes."}),"\n",(0,s.jsx)(i.p,{package:"@baeta/extension-cache-redis ioredis"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { RedisStore } from "@baeta/extension-cache-redis";\nimport Redis from "ioredis";\n\nconst redis = new Redis("redis://localhost:6379");\nconst store = new RedisStore(redis);\n'})}),"\n",(0,s.jsx)(n.h3,{id:"upstash-recommended-for-serverless",children:"Upstash (Recommended for Serverless)"}),"\n",(0,s.jsx)(n.p,{children:"Optimized for serverless environments."}),"\n",(0,s.jsx)(i.p,{package:"@baeta/extension-cache-upstash @upstash/redis"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { UpstashStore, UpstashClient } from "@baeta/extension-cache-upstash";\nimport { Redis } from "@upstash/redis";\n\nconst redis = new UpstashClient({\n  url: "UPSTASH_REDIS_URL",\n  token: "UPSTASH_REDIS_TOKEN",\n});\n\n// Or alternatively\n\nconst redis2 = new Redis({\n  url: "UPSTASH_REDIS_URL",\n  token: "UPSTASH_REDIS_TOKEN",\n  // This is very important as Baeta handles serialization/deserialization internally\n  automaticDeserialization: false,\n});\n\nconst store = new UpstashStore(redis);\n'})}),"\n",(0,s.jsx)(n.h3,{id:"cloudflare-durable-objects",children:"Cloudflare Durable Objects"}),"\n",(0,s.jsx)(n.p,{children:"TBA"}),"\n",(0,s.jsx)(n.h3,{id:"keyv-limited",children:"Keyv (Limited)"}),"\n",(0,s.jsx)(n.p,{children:"Simple key-value storage, suitable for development or small applications."}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"Not recommended for production with high query volumes."})}),"\n",(0,s.jsx)(i.p,{package:"@baeta/extension-cache-keyv keyv"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { KeyvStore } from "@baeta/extension-cache-keyv";\nimport Keyv from "keyv";\n\nconst keyv = new Keyv();\nconst store = new KeyvStore(keyv);\n'})}),"\n",(0,s.jsx)(n.h2,{id:"basic-setup",children:"Basic Setup"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Configure Cache Extension"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { cacheExtension } from "@baeta/extension-cache";\nimport { RedisStore } from "@baeta/extension-cache-redis";\nimport Redis from "ioredis";\n\nconst redis = new Redis("redis://localhost:6379");\nconst redisStore = new RedisStore(redis);\n\nexport const cacheExt = cacheExtension(redisStore, {\n  ttl: 3600, // TTL in seconds (defaults to 1 hour)\n});\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"Create Type-Specific Cache"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { getUserModule } from "./typedef.ts";\n\nconst { User, Query, Mutation } = getUserModule();\n\nexport const userCache = User.$createCache({\n  revision: 2, // Optional, cache version\n  ttl: 3600, // Optional, overrides default TTL\n});\n'})}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsxs)(n.p,{children:["When you modify type fields, the store will be automatically invalidated (its hash changes).\nFor scenarios where you want to invalidate the store manually, you can use the ",(0,s.jsx)(n.code,{children:"revision"})," option."]})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:"Register the Extension"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { createExtensions } from "@baeta/core";\nimport { cacheExt } from "./cache-extension";\n\nexport default createExtensions(\n  //... other extensions\n  cacheExt,\n  //... other extensions\n);\n'})}),"\n",(0,s.jsx)(n.h2,{id:"caching-examples",children:"Caching Examples"}),"\n",(0,s.jsx)(n.h3,{id:"basic-query-caching",children:"Basic Query Caching"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Simple approach\nQuery.user.$useCache(userCache);\nQuery.users.$useCache(userCache);\n\n// Or alternatively. This is same as above\nQuery.users.$use(userCache.createMiddleware(Query.users.$cacheRef));\n"})}),"\n",(0,s.jsx)(n.h3,{id:"mutation-handling",children:"Mutation Handling"}),"\n",(0,s.jsx)(n.p,{children:"Saving an entity to the store will also update all queries that reference it."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"Mutation.updateUser.$use(async (params, next) => {\n  const user = await next();\n  await userCache.save(user);\n  return user;\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"cache-clearing",children:"Cache Clearing"}),"\n",(0,s.jsx)(n.p,{children:"Because some queries that return lists have sorting or pagination capabilities, when inserting or deleting entities it is very difficult to compute how an update changes them.\nIt is easier to wipe them entirely."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"await Query.users.$cacheClear(userCache);\n\n// Or alternatively. This, again, is the same as above\nawait userCache.deleteQueries(Query.users.$cacheRef);\n"})}),"\n",(0,s.jsx)(n.p,{children:"For certain use cases, ie. an application where entities are scoped into organizations, it might be useful to clear queries that match only certain arguments."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'await Query.users.$cacheClear(userCache, {\n  args: {\n    where: {\n      organizationId: "specific-org",\n    },\n  },\n});\n'})}),"\n",(0,s.jsx)(n.h3,{id:"parent-based-cache-clearing",children:"Parent-Based Cache Clearing"}),"\n",(0,s.jsx)(n.p,{children:"For relationship queries, we can invalidate only the queries that reference a certain parentId."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"Mutation.createUserPhoto(async ({ args }) => {\n  const result = await db.userPhoto.create({\n    data: {\n      ...args.data,\n      userId: args.userId,\n    },\n  });\n\n  User.photos.$cacheClear(userPhotoCache, {\n    parentRef: args.userId,\n  });\n\n  return result;\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Choose the Right Adapter"}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Use Redis for production environments"}),"\n",(0,s.jsx)(n.li,{children:"Use Upstash for serverless applications"}),"\n",(0,s.jsx)(n.li,{children:"Avoid Keyv for high-traffic applications"}),"\n"]}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"Cache Invalidation Strategy"}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Use revision numbers to manually invalidate when needed"}),"\n",(0,s.jsx)(n.li,{children:"Implement parent-based invalidation for nested data"}),"\n",(0,s.jsx)(n.li,{children:"Clear list caches on mutations that affect ordering"}),"\n"]}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:"Performance Optimization"}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Set appropriate TTL values"}),"\n",(0,s.jsx)(n.li,{children:"Configure Redis to evacuate least used keys"}),"\n",(0,s.jsx)(n.li,{children:"Use selective cache clearing when possible"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["For detailed examples, see the Baeta caching ",(0,s.jsx)(n.a,{href:"https://github.com/andreisergiu98/baeta/tree/main/examples/cache",children:"example"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["There is also an ",(0,s.jsx)(n.a,{href:"https://github.com/andreisergiu98/baeta/tree/main/examples/cache-advanced",children:"advanced example"})," that showcases caching for weirdly shaped queries (like relay connectors)."]})]})}function h(e={}){let{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},31867:function(e,n,a){a.d(n,{b:()=>w,p:()=>b});var r=a(92669),s=a(1718),t=a(60650),i=a(66207);function l(e){let{children:n,hidden:a,className:s}=e;return(0,r.jsx)("div",{role:"tabpanel",className:(0,i.Z)("tabItem_iagj",s),hidden:a,children:n})}var c=a(36447),o=a(63497),d=a(89691),u=a(38789),h=a(88770),p=a(93970);function m(e){return t.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,t.isValidElement)(e)&&function(e){let{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function x(e){let{value:n,tabValues:a}=e;return a.some(e=>e.value===n)}var g=a(81820);function f(e){let{className:n,block:a,selectedValue:s,selectValue:t,tabValues:l}=e,o=[],{blockElementScrollPositionUntilNextRender:d}=(0,c.o5)(),u=e=>{let n=e.currentTarget,a=l[o.indexOf(n)].value;a!==s&&(d(n),t(a))},h=e=>{let n=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{let a=o.indexOf(e.currentTarget)+1;n=o[a]??o[0];break}case"ArrowLeft":{let a=o.indexOf(e.currentTarget)-1;n=o[a]??o[o.length-1]}}n?.focus()};return(0,r.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":a},n),children:l.map(e=>{let{value:n,label:a,attributes:t}=e;return(0,r.jsx)("li",{role:"tab",tabIndex:s===n?0:-1,"aria-selected":s===n,ref:e=>{o.push(e)},onKeyDown:h,onClick:u,...t,className:(0,i.Z)("tabs__item","tabItem_rLPU",t?.className,{"tabs__item--active":s===n}),children:a??n},n)})})}function v(e){let{lazy:n,children:a,selectedValue:s}=e,l=(Array.isArray(a)?a:[a]).filter(Boolean);if(n){let e=l.find(e=>e.props.value===s);return e?(0,t.cloneElement)(e,{className:(0,i.Z)("margin-top--md",e.props.className)}):null}return(0,r.jsx)("div",{className:"margin-top--md",children:l.map((e,n)=>(0,t.cloneElement)(e,{key:n,hidden:e.props.value!==s}))})}function j(e){let n=function(e){let{defaultValue:n,queryString:a=!1,groupId:r}=e,s=function(e){let{values:n,children:a}=e;return(0,t.useMemo)(()=>{let e=n??m(a).map(e=>{let{props:{value:n,label:a,attributes:r,default:s}}=e;return{value:n,label:a,attributes:r,default:s}}),r=(0,h.lx)(e,(e,n)=>e.value===n.value);if(r.length>0)throw Error(`Docusaurus error: Duplicate values "${r.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`);return e},[n,a])}(e),[i,l]=(0,t.useState)(()=>(function(e){let{defaultValue:n,tabValues:a}=e;if(0===a.length)throw Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!x({value:n,tabValues:a}))throw Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${a.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}let r=a.find(e=>e.default)??a[0];if(!r)throw Error("Unexpected error: 0 tabValues");return r.value})({defaultValue:n,tabValues:s})),[c,g]=function(e){let{queryString:n=!1,groupId:a}=e,r=(0,o.k6)(),s=function(e){let{queryString:n=!1,groupId:a}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!a)throw Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return a??null}({queryString:n,groupId:a});return[(0,u._X)(s),(0,t.useCallback)(e=>{if(!s)return;let n=new URLSearchParams(r.location.search);n.set(s,e),r.replace({...r.location,search:n.toString()})},[s,r])]}({queryString:a,groupId:r}),[f,v]=function(e){let{groupId:n}=e,a=n?`docusaurus.tab.${n}`:null,[r,s]=(0,p.Nk)(a);return[r,(0,t.useCallback)(e=>{a&&s.set(e)},[a,s])]}({groupId:r}),j=(()=>{let e=c??f;return x({value:e,tabValues:s})?e:null})();return(0,d.Z)(()=>{j&&l(j)},[j]),{selectedValue:i,selectValue:(0,t.useCallback)(e=>{if(!x({value:e,tabValues:s}))throw Error(`Can't select invalid tab value=${e}`);l(e),g(e),v(e)},[g,v,s]),tabValues:s}}(e);return(0,r.jsxs)("div",{className:(0,i.Z)("tabs-container","tabList_qd9z"),children:[(0,r.jsx)(f,{...n,...e}),(0,r.jsx)(v,{...n,...e})]})}function y(e){let n=(0,g.Z)();return(0,r.jsx)(j,{...e,children:m(e.children)},String(n))}function b(e){let n=e.dev?" -D":"";return(0,r.jsxs)(y,{groupId:"package-manager",children:[(0,r.jsx)(l,{value:"yarn",children:(0,r.jsxs)(s.Z,{language:"bash",children:["yarn add ",e.package,n]})}),(0,r.jsx)(l,{value:"npm",children:(0,r.jsxs)(s.Z,{language:"bash",children:["npm install ",e.package,n]})}),(0,r.jsx)(l,{value:"pnpm",children:(0,r.jsxs)(s.Z,{language:"bash",children:["pnpm add ",e.package,n]})}),(0,r.jsx)(l,{value:"bun",children:(0,r.jsxs)(s.Z,{language:"bash",children:["bun add ",e.package,n]})})]})}function w(e){return(0,r.jsxs)(y,{groupId:"package-manager",children:[(0,r.jsx)(l,{value:"yarn",children:(0,r.jsxs)(s.Z,{language:"bash",children:["yarn create ",e.package]})}),(0,r.jsx)(l,{value:"npm",children:(0,r.jsxs)(s.Z,{language:"bash",children:["npx create-",e.package]})}),(0,r.jsx)(l,{value:"pnpm",children:(0,r.jsxs)(s.Z,{language:"bash",children:["pnpm create ",e.package]})}),(0,r.jsx)(l,{value:"bun",children:(0,r.jsxs)(s.Z,{language:"bash",children:["bun create ",e.package]})}),(0,r.jsx)(l,{value:"yarn-2",label:"yarn 2+",children:(0,r.jsxs)(s.Z,{language:"bash",children:["yarn dlx create-",e.package]})})]})}},51846:function(e,n,a){a.d(n,{Z:()=>l,a:()=>i});var r=a(60650);let s={},t=r.createContext(s);function i(e){let n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);